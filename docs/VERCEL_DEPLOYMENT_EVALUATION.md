# Vercel éƒ¨ç½²è¯„ä¼°æŠ¥å‘Š

## ç»“è®ºæ¦‚è¦

| ç»„ä»¶ | Vercel å…¼å®¹æ€§ | è¯„ä¼° |
|------|---------------|------|
| **å‰ç«¯ (Next.js)** | âœ… å®Œå…¨å…¼å®¹ | å¯ç›´æŽ¥éƒ¨ç½² |
| **åŽç«¯ (FastAPI)** | âš ï¸ éƒ¨åˆ†å…¼å®¹ | éœ€è¦æ”¹é€ æˆ–å¤–éƒ¨éƒ¨ç½² |
| **æ²™ç®±æ‰§è¡Œ** | âŒ ä¸å…¼å®¹ | éœ€è¦å¤–éƒ¨æœåŠ¡å™¨ |
| **æ–‡ä»¶å­˜å‚¨** | âš ï¸ éœ€æ”¹é€  | éœ€è¦å¤–éƒ¨å­˜å‚¨æœåŠ¡ |

**æ€»ä½“è¯„ä¼°**: éœ€è¦**å‰åŽç«¯åˆ†ç¦»éƒ¨ç½²**ç­–ç•¥

---

## è¯¦ç»†åˆ†æž

### 1. å‰ç«¯ (web/) - âœ… å¯éƒ¨ç½²

**å½“å‰çŠ¶æ€**:
```
æ¡†æž¶: Next.js 16.0.10
React: 19.2.1
æž„å»º: bun run build âœ“
```

**Vercel å…¼å®¹é¡¹**:
- âœ… æ ‡å‡† Next.js é¡¹ç›®ç»“æž„
- âœ… æ— æœåŠ¡ç«¯æ¸²æŸ“ç‰¹æ®Šä¾èµ–
- âœ… ä½¿ç”¨æ ‡å‡† npm/bun ä¾èµ–
- âœ… çŽ¯å¢ƒå˜é‡æ”¯æŒ (`NEXT_PUBLIC_API_URL`)

**éƒ¨ç½²æ­¥éª¤**:
```bash
# 1. è¿žæŽ¥ Git ä»“åº“åˆ° Vercel
# 2. è®¾ç½® Root Directory: web
# 3. è®¾ç½®çŽ¯å¢ƒå˜é‡:
NEXT_PUBLIC_API_URL=https://your-api-domain.com
```

---

### 2. åŽç«¯ (api/) - âš ï¸ éœ€è¦æ”¹é€ 

**å½“å‰çŠ¶æ€**:
```
æ¡†æž¶: FastAPI
è¿è¡Œ: uvicorn api.main:app
ä¾èµ–: pydantic, pyyaml, jinja2, httpx, langchain, openai
```

**Vercel é™åˆ¶**:

| é™åˆ¶é¡¹ | Vercel Serverless | å½“å‰é¡¹ç›® |
|--------|-------------------|----------|
| æ‰§è¡Œæ—¶é—´ | 10-60ç§’ | æ²™ç®±æ‰§è¡Œå¯èƒ½è¶…æ—¶ |
| å†…å­˜ | 1024-3008MB | å¯èƒ½ä¸è¶³ |
| æ–‡ä»¶ç³»ç»Ÿ | åªè¯» (é™¤ /tmp) | éœ€è¦å†™å…¥å­˜å‚¨ |
| é•¿è¿žæŽ¥ | ä¸æ”¯æŒæŒä¹…è¿žæŽ¥ | SSE æµå¯èƒ½å—å½±å“ |
| å­è¿›ç¨‹ | å—é™ | æ²™ç®±ä¾èµ–å­è¿›ç¨‹ |

**Vercel Functions æ–¹æ¡ˆ (ä¸æŽ¨è)**:

```python
# api/index.py (Vercel Serverless Function)
from fastapi import FastAPI
from mangum import Mangum  # AWS Lambda adapter

app = FastAPI()
# ... è·¯ç”±å®šä¹‰

handler = Mangum(app)  # Vercel ä½¿ç”¨ AWS Lambda è¿è¡Œæ—¶
```

é—®é¢˜:
- SSE æµå¼å“åº”ä¸ç¨³å®š
- æ²™ç®±æ‰§è¡Œä¼šè¶…æ—¶
- æ— æ³•è¿è¡Œ Docker

---

### 3. æ²™ç®±æ‰§è¡Œ - âŒ ä¸å…¼å®¹

**ç¡¬æ€§é™åˆ¶**:

| åŠŸèƒ½ | éœ€æ±‚ | Vercel æ”¯æŒ |
|------|------|-------------|
| ProcessSandbox | subprocess æ‰§è¡Œ | âŒ å—é™ |
| DockerSandbox | Docker å®¹å™¨ | âŒ ä¸æ”¯æŒ |
| æ–‡ä»¶ I/O | è¯»å†™å·¥ä½œç›®å½• | âŒ åªæœ‰ /tmp |
| é•¿æ—¶é—´æ‰§è¡Œ | æœ€é•¿ 180 ç§’ | âŒ æœ€é•¿ 60 ç§’ |
| åŒ…å®‰è£… | pip install | âŒ ä¸æ”¯æŒ |

**ç»“è®º**: æ²™ç®±å¿…é¡»è¿è¡Œåœ¨ç‹¬ç«‹æœåŠ¡å™¨

---

### 4. æ–‡ä»¶å­˜å‚¨ - âš ï¸ éœ€æ”¹é€ 

**å½“å‰å®žçŽ°**:
```python
# api/storage.py
class FileStorage:
    def __init__(self):
        self.base_path = Path("./storage")  # æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
```

**Vercel é™åˆ¶**:
- æ— æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿ
- /tmp ç›®å½•åœ¨è¯·æ±‚é—´ä¸å…±äº«
- æœ€å¤§ /tmp å®¹é‡ 512MB

**æ›¿ä»£æ–¹æ¡ˆ**:

| æ–¹æ¡ˆ | æœåŠ¡ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| å¯¹è±¡å­˜å‚¨ | AWS S3 / Cloudflare R2 | ä¾¿å®œã€å¯é  | éœ€æ”¹é€ ä»£ç  |
| æ•°æ®åº“å­˜å‚¨ | Vercel Blob | åŽŸç”Ÿé›†æˆ | å®¹é‡é™åˆ¶ |
| å¤–éƒ¨æœåŠ¡ | Supabase Storage | å…è´¹é¢åº¦ | å¤šä¸€å±‚ä¾èµ– |

---

## æŽ¨èéƒ¨ç½²æž¶æž„

### æ–¹æ¡ˆ A: å‰åŽç«¯åˆ†ç¦» (æŽ¨è)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Vercel                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Next.js å‰ç«¯                            â”‚    â”‚
â”‚  â”‚         cape-web.vercel.app                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS API è¯·æ±‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨æœåŠ¡å™¨ (Railway / Fly.io / VPS)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              FastAPI åŽç«¯                            â”‚    â”‚
â”‚  â”‚         api.cape-system.com                         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚   æ²™ç®±æ‰§è¡Œ   â”‚  â”‚  æ–‡ä»¶å­˜å‚¨   â”‚  â”‚  LLM Agent  â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‘å­˜å‚¨ (å¯é€‰)                              â”‚
â”‚           AWS S3 / Cloudflare R2 / Supabase                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æˆæœ¬ä¼°ç®—**:

| æœåŠ¡ | å…è´¹é¢åº¦ | ä»˜è´¹èµ·æ­¥ |
|------|----------|----------|
| Vercel (å‰ç«¯) | 100GB å¸¦å®½/æœˆ | $20/æœˆ |
| Railway (åŽç«¯) | $5 å…è´¹é¢åº¦ | $5+/æœˆ |
| Fly.io (åŽç«¯) | 3 shared VMs | $5+/æœˆ |
| Cloudflare R2 | 10GB å­˜å‚¨ | $0.015/GB |

---

### æ–¹æ¡ˆ B: å…¨ Railway/Fly.io

å¦‚æžœä¸æƒ³æ‹†åˆ†ï¼Œå¯ä»¥å…¨éƒ¨éƒ¨ç½²åˆ°æ”¯æŒ Docker çš„å¹³å°ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Railway / Fly.io / Render                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   Docker å®¹å™¨                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Next.js å‰ç«¯  â”‚  â”‚      FastAPI åŽç«¯         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚    :3000      â”‚  â”‚         :8000             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                            â”‚                        â”‚    â”‚
â”‚  â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                â”‚    â”‚
â”‚  â”‚                     â”‚  æ²™ç®±å®¹å™¨    â”‚                â”‚    â”‚
â”‚  â”‚                     â”‚  (DinD/DooD) â”‚                â”‚    â”‚
â”‚  â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**: æž¶æž„ç®€å•ã€æ²™ç®±å®Œæ•´æ”¯æŒ
**ç¼ºç‚¹**: éœ€è¦ Docker-in-Docker æˆ– Docker-out-of-Docker

---

## éƒ¨ç½²æ¸…å•

### å‰ç«¯éƒ¨ç½²åˆ° Vercel

```bash
# 1. å®‰è£… Vercel CLI
npm i -g vercel

# 2. ç™»å½•
vercel login

# 3. éƒ¨ç½²
cd web
vercel

# 4. è®¾ç½®çŽ¯å¢ƒå˜é‡
vercel env add NEXT_PUBLIC_API_URL
# è¾“å…¥: https://your-api-server.com
```

**vercel.json** (å¯é€‰):
```json
{
  "buildCommand": "bun run build",
  "outputDirectory": ".next",
  "framework": "nextjs"
}
```

### åŽç«¯éƒ¨ç½²åˆ° Railway

```bash
# 1. åˆ›å»º Dockerfile
cat > Dockerfile << 'EOF'
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    libreoffice-calc \
    poppler-utils \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python ä¾èµ–
COPY pyproject.toml .
RUN pip install -e ".[all]"

# å¤åˆ¶ä»£ç 
COPY . .

# å¯åŠ¨
CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000"]
EOF

# 2. æŽ¨é€åˆ° GitHub
git add . && git commit -m "Add Dockerfile"
git push

# 3. åœ¨ Railway åˆ›å»ºé¡¹ç›®å¹¶è¿žæŽ¥ GitHub
```

**railway.json**:
```json
{
  "build": {
    "builder": "dockerfile"
  },
  "deploy": {
    "startCommand": "uvicorn api.main:app --host 0.0.0.0 --port $PORT",
    "healthcheckPath": "/",
    "restartPolicyType": "on_failure"
  }
}
```

---

## éœ€è¦ä¿®æ”¹çš„ä»£ç 

### 1. å­˜å‚¨å±‚æ”¹é€  (ä½¿ç”¨ S3)

```python
# api/storage_s3.py
import boto3
from botocore.config import Config

class S3Storage:
    def __init__(self):
        self.s3 = boto3.client(
            's3',
            endpoint_url=os.getenv('S3_ENDPOINT'),  # Cloudflare R2 å…¼å®¹
            aws_access_key_id=os.getenv('S3_ACCESS_KEY'),
            aws_secret_access_key=os.getenv('S3_SECRET_KEY'),
        )
        self.bucket = os.getenv('S3_BUCKET', 'cape-storage')

    async def save_upload(self, file, session_id, **kwargs):
        key = f"uploads/{session_id}/{file.filename}"
        self.s3.upload_fileobj(file.file, self.bucket, key)
        # ...

    async def get_file(self, file_id):
        response = self.s3.get_object(Bucket=self.bucket, Key=file_id)
        return response['Body'].read()
```

### 2. çŽ¯å¢ƒå˜é‡é…ç½®

```bash
# åŽç«¯ (.env)
OPENAI_API_KEY=sk-xxx
OPENAI_BASE_URL=https://api.openai.com/v1

# å­˜å‚¨
S3_ENDPOINT=https://xxx.r2.cloudflarestorage.com
S3_ACCESS_KEY=xxx
S3_SECRET_KEY=xxx
S3_BUCKET=cape-storage

# CORS
CORS_ORIGINS=https://cape-web.vercel.app
```

### 3. å‰ç«¯ API URL

```typescript
// web/.env.production
NEXT_PUBLIC_API_URL=https://cape-api.railway.app
```

---

## ç«‹å³å¯éƒ¨ç½²çš„æœ€å°æ–¹æ¡ˆ

å¦‚æžœåªéœ€è¦**å±•ç¤º Demo**ï¼Œå¯ä»¥å…ˆéƒ¨ç½²ä¸å«æ²™ç®±æ‰§è¡Œçš„ç‰ˆæœ¬ï¼š

```
âœ… å‰ç«¯ (Vercel)
âœ… Cape åˆ—è¡¨å±•ç¤º
âœ… èƒ½åŠ›åŒ¹é… API
âœ… èŠå¤©ç•Œé¢ (è°ƒç”¨å¤–éƒ¨ LLM)
âŒ ä»£ç æ‰§è¡Œ (ç¦ç”¨)
âŒ æ–‡ä»¶å¤„ç† (ç¦ç”¨)
```

```python
# api/deps.py - ç¦ç”¨æ²™ç®±
SANDBOX_ENABLED = os.getenv("SANDBOX_ENABLED", "false") == "true"

# api/routes/files.py - ç¦ç”¨æ–‡ä»¶å¤„ç†
@router.post("/{file_id}/process")
async def process_file(...):
    if not SANDBOX_ENABLED:
        raise HTTPException(501, "Sandbox execution not available in demo mode")
```

---

## æ€»ç»“

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| Vercel ä¸æ”¯æŒé•¿æ—¶é—´è¿è¡Œ | åŽç«¯éƒ¨ç½²åˆ° Railway/Fly.io |
| Vercel ä¸æ”¯æŒ Docker | ä½¿ç”¨ ProcessSandbox æˆ–å¤–éƒ¨æ²™ç®±æœåŠ¡ |
| æ–‡ä»¶å­˜å‚¨ä¸æŒä¹… | ä½¿ç”¨ S3/R2 å¯¹è±¡å­˜å‚¨ |
| SSE å¯èƒ½ä¸ç¨³å®š | è€ƒè™‘ WebSocket æˆ–è½®è¯¢æ›¿ä»£ |

**æŽ¨èè·¯å¾„**:
1. âœ… å‰ç«¯ç«‹å³éƒ¨ç½²åˆ° Vercel
2. â³ åŽç«¯éƒ¨ç½²åˆ° Railway (å« ProcessSandbox)
3. â³ å­˜å‚¨æ”¹é€ ä¸º S3/R2
4. ðŸ”® æœªæ¥è€ƒè™‘ä¸“ç”¨æ²™ç®±æœåŠ¡ (Modal, Replicate)

---

*è¯„ä¼°æ—¶é—´: 2025-12-18*
